name: CICD

on: [push]

env:
  WEBSITE_REPO: flowbrew/website-deployment

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    container: 
      image: ntoss/builder:latest
    env:
      BUILD_PATH: ./_site
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: Notify slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        uses: pullreminders/slack-action@master
        with:
          args: '{\"channel\":\"CS6U3AL7M\",\"text\":\"Hello world\"}'

      # Saving branch name to ${BRANCH_NAME}
      - uses: nelonoel/branch-name@v1

      - uses: actions/checkout@v1
      - name: Build Jekyll
        run: |
          pip install pyyaml
          .github/workflows/scripts/build.py \
              -d ${{ env.BUILD_PATH }} \
              -r ${{ github.repository }} \
              -S ${{ github.sha }} \
              -b ${{ env.BRANCH_NAME }}

      - name: Deploy Jekyll
        run: |
          pip install beautifulsoup4
          pip install path
          .github/workflows/scripts/deploy.py \
              -t ${{ secrets.GITHUB_WEBSITE_TOKEN }} \
              -u ${{ secrets.GITHUB_WEBSITE_USERNAME }} \
              -r ${{ env.WEBSITE_REPO }} \
              -s ${{ env.BUILD_PATH }} \
              -S ${{ github.sha }} \
              -b ${{ env.BRANCH_NAME }}
