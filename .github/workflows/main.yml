name: CICD

on: [push]

env:
  WEBSITE_REPO: flowbrew/website-deployment
  SCRIPTS_PATH: .github/workflows/scripts
  REPOSITORY: ${{ github.repository }}
  WORKFLOW: ${{ github.workflow }}
  EVENT_NAME: ${{ github.event_name }}
  HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
  HEAD_COMMIT_URL: ${{ github.event.head_commit.url }}

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    container: 
      image: ntoss/builder:latest
    env:
      BUILD_PATH: ./_site
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      # Saving branch name to ${BRANCH_NAME}
      - uses: nelonoel/branch-name@v1

      - uses: actions/checkout@v1
      - name: Install pybrew
        run: |
          pip install ./pybrew
          pytest --pyargs pybrew \
            --SLACK_BOT_TOKEN=${{ secrets.SLACK_BOT_TOKEN }}

      - name: Build Jekyll
        run: |
          ${{ env.SCRIPTS_PATH }}/build.py \
              -d ${{ env.BUILD_PATH }} \
              -r ${{ github.repository }} \
              -S ${{ github.sha }} \
              -b ${{ env.BRANCH_NAME }}

      - name: Deploy Jekyll
        run: |
          ${{ env.SCRIPTS_PATH }}/deploy.py \
              -t ${{ secrets.GITHUB_WEBSITE_TOKEN }} \
              -u ${{ secrets.GITHUB_WEBSITE_USERNAME }} \
              -r ${{ env.WEBSITE_REPO }} \
              -s ${{ env.BUILD_PATH }} \
              -S ${{ github.sha }} \
              -b ${{ env.BRANCH_NAME }}

      - name: Notify
        if: always()
        env:
          FAILURE: failure()
          SECRET_SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: ${{ env.SCRIPTS_PATH }}/notifier.py
